<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HEAD TAIL - PRO FIXED</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <style>
        :root { --gold: #ffd700; --gold-dark: #b8860b; }
        body { 
            background: #000; 
            font-family: 'Montserrat', sans-serif; 
            color: white; 
            overflow: hidden; 
            perspective: 1000px;
            touch-action: manipulation;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .casino-bg {
            position: fixed; inset: 0; z-index: -2;
            background: radial-gradient(circle at center, #1a0f00, #000000);
        }
        
        .back-btn { 
            position: absolute; top: 20px; left: 20px; z-index: 60; 
            color: white; font-size: 24px; cursor: pointer; 
            background: rgba(0,0,0,0.5); padding: 10px; border-radius: 50%;
        }

        .game-header {
            padding: 20px;
            padding-top: 80px; 
            display: flex; justify-content: space-between; align-items: center;
            z-index: 10;
        }

        .coin-wrapper {
            flex: 1;
            display: flex; justify-content: center; align-items: center;
            position: relative; z-index: 0;
        }
        
        .coin-stage {
            width: 180px; height: 180px;
            position: relative; transform-style: preserve-3d;
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-15px);} }
        
        .coin {
            width: 100%; height: 100%; position: absolute;
            transform-style: preserve-3d;
        }

        .face {
            position: absolute; width: 100%; height: 100%; rounded-full;
            backface-visibility: hidden; display: flex; align-items: center; justify-content: center;
            border-radius: 50%;
            border: 8px solid var(--gold);
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8), 0 0 30px rgba(255, 215, 0, 0.3);
        }
        .face-inner {
            width: 85%; height: 85%; border-radius: 50%; border: 2px dashed rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center;
            background: radial-gradient(circle, #fff7cc, var(--gold));
        }
        .heads { transform: rotateY(0deg) translateZ(5px); }
        .tails { transform: rotateY(180deg) translateZ(5px); background: linear-gradient(135deg, #e0e0e0, #999); border-color: #ccc; }
        .tails .face-inner { background: radial-gradient(circle, #fff, #bbb); }
        
        .coin::before {
            content: ''; position: absolute; width: 100%; height: 100%; border-radius: 50%;
            background: #886600;
            transform: rotateY(90deg) translateX(-5px); width: 10px; left: 50%;
        }

        .toss-anim { animation: toss 1s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        .spin-rapid { animation: spin 0.5s linear infinite; }
        @keyframes toss { 0% {transform: translateY(0) scale(1);} 50% {transform: translateY(-300px) scale(0.8);} 100% {transform: translateY(0) scale(1);} }
        @keyframes spin { to { transform: rotateY(3600deg); } }

        .controls-area {
            background: rgba(20, 20, 20, 0.95);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            padding-bottom: 40px;
            z-index: 50;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.5);
        }

        .chip-rack {
            display: flex; gap: 15px; justify-content: center; margin-bottom: 20px;
        }
        .chip {
            width: 55px; height: 55px; border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: 900; font-size: 13px; cursor: pointer;
            border: 3px dashed rgba(255,255,255,0.5);
            box-shadow: 0 5px 10px rgba(0,0,0,0.5);
            transition: 0.2s; position: relative;
        }
        .chip:active { transform: scale(0.9); }
        .chip.selected { transform: translateY(-10px) scale(1.1); box-shadow: 0 10px 20px rgba(0,0,0,0.8); border-style: solid; color: white; border-width: 3px; }
        
        .c-20 { background: #0088ff; color: #cceeff; border-color: #0055aa; }
        .c-50 { background: #00cc44; color: #ccffdd; border-color: #008822; }
        .c-100 { background: #ff3333; color: #ffcccc; border-color: #aa0000; }
        .c-500 { background: #222; color: #ffd700; border-color: #ffd700; }

        .side-btn {
            flex: 1; padding: 15px; border-radius: 12px;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            transition: 0.2s; display: flex; flex-direction: column; align-items: center; cursor: pointer;
        }
        .side-btn.active { background: rgba(255, 215, 0, 0.2); border-color: gold; box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); }

        .flip-btn {
            width: 100%; padding: 18px; border-radius: 12px;
            background: linear-gradient(to right, #ffd700, #ffaa00);
            color: black; font-weight: 900; font-size: 22px; letter-spacing: 2px;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.4);
            transition: 0.2s; margin-top: 15px;
        }
        .flip-btn:active { transform: scale(0.98); }
        
        .win-overlay {
            position: fixed; inset: 0; pointer-events: none; z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; transition: 0.3s; transform: scale(0.8);
            background: rgba(0,0,0,0.8);
        }
        .win-overlay.show { opacity: 1; transform: scale(1); }
        .win-msg { font-size: 50px; font-weight: 900; color: #0f0; text-shadow: 0 0 20px #0f0; }
        .win-amount { font-size: 30px; font-weight: bold; color: white; margin-top: 10px; }

    </style>
</head>
<body onclick="initAudio()"> 

    <div class="casino-bg"></div>
    <a href="index.html" class="back-btn"><i class="fa-solid fa-arrow-left"></i></a>

    <div class="game-header">
        <div>
            <p class="text-xs text-gray-400 font-bold tracking-widest uppercase">BALANCE</p>
            <h2 class="text-3xl font-black text-white drop-shadow-md">Rs. <span id="balanceDisplay">...</span></h2>
        </div>
        <div class="text-right">
            <div class="bg-white/10 px-4 py-1 rounded-full border border-white/20 flex items-center gap-2">
                <i class="fa-solid fa-fire text-orange-500"></i> 
                <span id="streakDisplay" class="font-bold text-sm">0</span>
            </div>
        </div>
    </div>

    <div class="coin-wrapper">
        <div id="coinStage" class="coin-stage">
            <div id="theCoin" class="coin">
                <div class="face heads"><div class="face-inner"><i class="fa-solid fa-crown text-6xl text-yellow-900"></i></div></div>
                <div class="face tails"><div class="face-inner"><i class="fa-solid fa-dragon text-6xl text-gray-800"></i></div></div>
            </div>
        </div>
        <p id="statusText" class="absolute bottom-10 text-gray-500 font-bold tracking-widest text-sm w-full text-center">SELECT SIDE & BET</p>
    </div>

    <div id="winScreen" class="win-overlay">
        <h1 class="win-msg">YOU WON!</h1>
        <p class="win-amount" id="winAmountText">+ Rs. 0</p>
    </div>

    <div class="controls-area">
        
        <div class="chip-rack">
            <div onclick="selectChip(20, this)" class="chip c-20 selected">20</div>
            <div onclick="selectChip(50, this)" class="chip c-50">50</div>
            <div onclick="selectChip(100, this)" class="chip c-100">100</div>
            <div onclick="selectChip(500, this)" class="chip c-500">500</div>
        </div>

        <div class="flex gap-4">
            <div onclick="pickSide('head')" id="btn-head" class="side-btn">
                <i class="fa-solid fa-crown text-3xl mb-1 text-yellow-500"></i>
                <span class="font-bold text-xs">HEADS</span>
            </div>
            <div onclick="pickSide('tail')" id="btn-tail" class="side-btn">
                <i class="fa-solid fa-dragon text-3xl mb-1 text-gray-400"></i>
                <span class="font-bold text-xs">TAILS</span>
            </div>
        </div>

        <button onclick="flipCoin()" id="flipBtn" class="flip-btn">FLIP NOW</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCPLmQny1WP7yZXJuh5xjiMvU2ArfC-n54",
            authDomain: "ultra-earn-a636a.firebaseapp.com",
            projectId: "ultra-earn-a636a",
            storageBucket: "ultra-earn-a636a.firebasestorage.app",
            messagingSenderId: "185942357584",
            appId: "1:185942357584:web:1052b94cfecc6576944355"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUser = null;
        let myBalance = 0;
        let myStreak = 0;
        
        let currentBet = 20; 
        let selectedSide = null;
        let isFlipping = false;

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                db.ref('users/' + user.uid).on('value', snap => {
                    const data = snap.val();
                    myBalance = data.balance || 0;
                    myStreak = data.streak || 0;
                    document.getElementById('balanceDisplay').innerText = myBalance.toFixed(2);
                    document.getElementById('streakDisplay').innerText = myStreak;
                });
            } else {
                window.location.href = 'index.html';
            }
        });

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let audioInit = false;

        function initAudio() {
            if (!audioInit) {
                audioCtx.resume();
                audioInit = true;
            }
        }

        function playSound(type) {
            initAudio();
            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);

            if (type === 'chip') {
                osc.frequency.setValueAtTime(1500, t);
                gain.gain.setValueAtTime(0.1, t); gain.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
                osc.start(t); osc.stop(t + 0.1);
            } else if (type === 'spin') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(200, t); osc.frequency.linearRampToValueAtTime(400, t+0.5);
                gain.gain.setValueAtTime(0.2, t); gain.gain.linearRampToValueAtTime(0, t+0.5);
                osc.start(t); osc.stop(t+0.5);
            } else if (type === 'win') {
                osc.type = 'square'; osc.frequency.setValueAtTime(400, t); 
                gain.gain.setValueAtTime(0.2, t); gain.gain.exponentialRampToValueAtTime(0.01, t+0.5);
                osc.start(t); osc.stop(t+0.5);
            } else if (type === 'lose') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, t); 
                gain.gain.setValueAtTime(0.2, t); gain.gain.exponentialRampToValueAtTime(0.01, t+0.3);
                osc.start(t); osc.stop(t+0.3);
            }
        }

        function selectChip(val, el) {
            if(isFlipping) return;
            currentBet = val;
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            playSound('chip');
        }

        function pickSide(side) {
            if(isFlipping) return;
            selectedSide = side;
            document.querySelectorAll('.side-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + side).classList.add('active');
            playSound('chip');
        }

        function flipCoin() {
            if(isFlipping) return;
            if(!selectedSide) return alert("Select Head or Tail");
            if(myBalance < currentBet) return alert("Insufficient Balance");

            isFlipping = true;
            initAudio(); 

            // 1. DEDUCT
            const newBal = myBalance - currentBet;
            db.ref('users/' + currentUser.uid).update({ balance: newBal });

            // 2. RISK ENGINE (30% Win / 70% Lose)
            let winChance = 0.3; // 30% Chance to Win
            
            // Extra safety: Big bets or high streaks get lower chance
            if (currentBet >= 500) winChance = 0.1; // 10%
            if (myStreak >= 3) winChance = 0; // 0%

            const isWin = Math.random() < winChance;
            const result = isWin ? selectedSide : (selectedSide === 'head' ? 'tail' : 'head');

            // 3. ANIMATION
            const stage = document.getElementById('coinStage');
            const coin = document.getElementById('theCoin');
            const status = document.getElementById('statusText');
            
            status.innerText = "FLIPPING...";
            playSound('spin');
            
            stage.classList.add('toss-anim');
            coin.classList.add('spin-rapid'); 
            
            const finalRot = 3600 + (result === 'head' ? 0 : 180);
            coin.style.transform = `rotateY(${finalRot}deg)`;

            // 4. RESULT
            setTimeout(() => {
                stage.classList.remove('toss-anim');
                coin.style.transition = 'none';
                coin.style.transform = result === 'head' ? 'rotateY(0deg)' : 'rotateY(180deg)';
                coin.classList.remove('spin-rapid');
                
                if(isWin) {
                    const profit = currentBet * 2;
                    db.ref('users/' + currentUser.uid).update({ 
                        balance: myBalance + profit, 
                        streak: myStreak + 1
                    });
                    showWin(profit);
                } else {
                    db.ref('users/' + currentUser.uid).update({ streak: 0 });
                    playSound('lose');
                    status.innerText = "YOU LOST";
                    status.classList.add('text-red-500');
                }

                // Cleanup
                setTimeout(() => {
                    isFlipping = false;
                    coin.style.transition = 'transform 3s'; 
                    status.classList.remove('text-red-500');
                    status.innerText = "PLAY AGAIN";
                }, 1500);

            }, 1000);
        }

        function showWin(amount) {
            const el = document.getElementById('winScreen');
            document.getElementById('winAmountText').innerText = "+ Rs. " + amount;
            el.classList.add('show');
            playSound('win');
            if(navigator.vibrate) navigator.vibrate(200);
            setTimeout(() => el.classList.remove('show'), 1500);
        }

    </script>
</body>
</html>
