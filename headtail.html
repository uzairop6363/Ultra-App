<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HEAD TAIL - PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <style>
        :root { --gold: #ffd700; --gold-dark: #b8860b; }
        body { 
            background: #000; 
            font-family: 'Montserrat', sans-serif; 
            color: white; 
            overflow: hidden; 
            perspective: 1000px;
            touch-action: manipulation;
        }

        /* --- BACKGROUND --- */
        .casino-bg {
            position: fixed; inset: 0; z-index: -2;
            background: radial-gradient(circle at center, #1a0f00, #000000);
        }
        .felt-pattern {
            position: fixed; inset: 0; opacity: 0.1;
            background-image: url('https://www.transparenttextures.com/patterns/carbon-fibre.png');
            pointer-events: none;
        }

        /* --- 3D COIN --- */
        .coin-stage {
            width: 180px; height: 180px; margin: 0 auto;
            position: relative; transform-style: preserve-3d;
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-10px);} }
        
        .coin {
            width: 100%; height: 100%; position: absolute;
            transform-style: preserve-3d;
        }

        .face {
            position: absolute; width: 100%; height: 100%; rounded-full;
            backface-visibility: hidden; display: flex; align-items: center; justify-content: center;
            border-radius: 50%;
            border: 8px solid var(--gold);
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8), 0 0 30px rgba(255, 215, 0, 0.3);
        }
        .face-inner {
            width: 85%; height: 85%; border-radius: 50%; border: 2px dashed rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center;
            background: radial-gradient(circle, #fff7cc, var(--gold));
        }
        .heads { transform: rotateY(0deg) translateZ(5px); }
        .tails { transform: rotateY(180deg) translateZ(5px); background: linear-gradient(135deg, #e0e0e0, #999); border-color: #ccc; }
        .tails .face-inner { background: radial-gradient(circle, #fff, #bbb); }
        
        .coin::before {
            content: ''; position: absolute; width: 100%; height: 100%; border-radius: 50%;
            background: #886600;
            transform: rotateY(90deg) translateX(-5px); width: 10px; left: 50%;
        }

        /* --- ANIMATIONS --- */
        .toss-anim { animation: toss 1s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        .spin-anim { animation: spin 0.5s linear infinite; }
        @keyframes toss { 0% {transform: translateY(0) scale(1);} 50% {transform: translateY(-300px) scale(0.8);} 100% {transform: translateY(0) scale(1);} }
        @keyframes spin { to { transform: rotateY(3600deg); } }

        /* --- UI ELEMENTS --- */
        .glass-panel {
            background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(15px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 -10px 40px rgba(0,0,0,0.8);
        }

        /* Chips */
        .chip-rack {
            display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;
        }
        .chip {
            width: 60px; height: 60px; border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: 900; font-size: 14px; cursor: pointer;
            border: 4px dashed rgba(255,255,255,0.5);
            box-shadow: 0 5px 10px rgba(0,0,0,0.5);
            transition: 0.2s; position: relative;
        }
        .chip:active { transform: scale(0.9); }
        .chip.selected { transform: translateY(-10px) scale(1.1); box-shadow: 0 15px 20px rgba(0,0,0,0.6); border-style: solid; color: white; }
        
        .c-20 { background: #0088ff; color: #cceeff; border-color: #0055aa; }
        .c-50 { background: #00cc44; color: #ccffdd; border-color: #008822; }
        .c-100 { background: #ff3333; color: #ffcccc; border-color: #aa0000; }
        .c-500 { background: #222; color: #ffd700; border-color: #ffd700; }

        /* Side Buttons */
        .side-btn {
            flex: 1; padding: 15px; border-radius: 12px;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            transition: 0.2s; display: flex; flex-direction: column; align-items: center;
        }
        .side-btn.active { background: rgba(255, 215, 0, 0.2); border-color: gold; box-shadow: 0 0 20px rgba(255, 215, 0, 0.2); }

        /* Flip Button */
        .flip-btn {
            width: 100%; padding: 20px; border-radius: 12px;
            background: linear-gradient(to right, #ffd700, #ffaa00);
            color: black; font-weight: 900; font-size: 24px; letter-spacing: 2px;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.4);
            transition: 0.2s; margin-top: 10px;
        }
        .flip-btn:active { transform: scale(0.98); }
        .flip-btn:disabled { filter: grayscale(1); opacity: 0.5; }

        .back-btn { position: absolute; top: 20px; left: 20px; color: white; font-size: 24px; z-index: 50; }
        
        /* Win Splash */
        .win-overlay {
            position: fixed; inset: 0; pointer-events: none; z-index: 100;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: 0.3s; transform: scale(0.8);
        }
        .win-overlay.show { opacity: 1; transform: scale(1); }
        .win-msg { font-size: 60px; font-weight: 900; color: #0f0; text-shadow: 0 0 20px #0f0; }

    </style>
</head>
<body onclick="initAudio()"> <div class="casino-bg"></div>
    <div class="felt-pattern"></div>
    <a href="index.html" class="back-btn"><i class="fa-solid fa-arrow-left"></i></a>

    <div class="p-6 flex justify-between items-center relative z-10 mt-10">
        <div>
            <p class="text-xs text-gray-400 font-bold tracking-widest uppercase">Your Balance</p>
            <h2 class="text-3xl font-black text-white drop-shadow-md">Rs. <span id="balanceDisplay">...</span></h2>
        </div>
        <div class="text-right">
            <div class="bg-white/10 px-4 py-1 rounded-full border border-white/20">
                <i class="fa-solid fa-fire text-orange-500"></i> <span id="streakDisplay">0</span>
            </div>
        </div>
    </div>

    <div class="flex-1 flex flex-col items-center justify-center relative z-0 perspective-[1000px] mb-40">
        <div id="coinStage" class="coin-stage">
            <div id="theCoin" class="coin">
                <div class="face heads"><div class="face-inner"><i class="fa-solid fa-crown text-6xl text-yellow-900"></i></div></div>
                <div class="face tails"><div class="face-inner"><i class="fa-solid fa-dragon text-6xl text-gray-800"></i></div></div>
            </div>
        </div>
        <p id="statusText" class="text-gray-500 font-bold tracking-widest mt-10 text-sm">SELECT YOUR SIDE</p>
    </div>

    <div id="winScreen" class="win-overlay">
        <h1 class="win-msg">YOU WON!</h1>
    </div>

    <div class="fixed bottom-0 w-full glass-card p-6 rounded-t-3xl z-50">
        
        <div class="chip-rack">
            <div onclick="selectChip(20, this)" class="chip c-20 selected">20</div>
            <div onclick="selectChip(50, this)" class="chip c-50">50</div>
            <div onclick="selectChip(100, this)" class="chip c-100">100</div>
            <div onclick="selectChip(500, this)" class="chip c-500">500</div>
        </div>

        <div class="flex gap-4 mb-4">
            <div onclick="pickSide('head')" id="btn-head" class="side-btn">
                <i class="fa-solid fa-crown text-3xl mb-1 text-yellow-500"></i>
                <span class="font-bold text-xs">HEADS</span>
            </div>
            <div onclick="pickSide('tail')" id="btn-tail" class="side-btn">
                <i class="fa-solid fa-dragon text-3xl mb-1 text-gray-400"></i>
                <span class="font-bold text-xs">TAILS</span>
            </div>
        </div>

        <button onclick="flipCoin()" id="flipBtn" class="flip-btn">FLIP NOW</button>
    </div>

    <script>
        // === FIREBASE CONFIG ===
        const firebaseConfig = {
            apiKey: "AIzaSyCPLmQny1WP7yZXJuh5xjiMvU2ArfC-n54",
            authDomain: "ultra-earn-a636a.firebaseapp.com",
            projectId: "ultra-earn-a636a",
            storageBucket: "ultra-earn-a636a.firebasestorage.app",
            messagingSenderId: "185942357584",
            appId: "1:185942357584:web:1052b94cfecc6576944355"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUser = null;
        let myBalance = 0;
        let myStreak = 0;
        
        // Game State
        let currentBet = 20; // Default Chip
        let selectedSide = null;
        let isFlipping = false;

        // AUTH
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                db.ref('users/' + user.uid).on('value', snap => {
                    const data = snap.val();
                    myBalance = data.balance || 0;
                    myStreak = data.streak || 0;
                    document.getElementById('balanceDisplay').innerText = myBalance.toFixed(2);
                    document.getElementById('streakDisplay').innerText = myStreak;
                });
            } else {
                window.location.href = 'index.html';
            }
        });

        // === SOUND ENGINE (FIXED) ===
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let audioInit = false;

        function initAudio() {
            if (!audioInit) {
                audioCtx.resume();
                audioInit = true;
            }
        }

        function playSound(type) {
            initAudio();
            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);

            if (type === 'chip') {
                osc.frequency.setValueAtTime(1500, t);
                gain.gain.setValueAtTime(0.1, t); gain.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
                osc.start(t); osc.stop(t + 0.1);
            } else if (type === 'spin') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(200, t); osc.frequency.linearRampToValueAtTime(400, t+0.5);
                gain.gain.setValueAtTime(0.2, t); gain.gain.linearRampToValueAtTime(0, t+0.5);
                osc.start(t); osc.stop(t+0.5);
            } else if (type === 'win') {
                osc.type = 'square'; osc.frequency.setValueAtTime(400, t); 
                gain.gain.setValueAtTime(0.2, t); gain.gain.exponentialRampToValueAtTime(0.01, t+0.5);
                osc.start(t); osc.stop(t+0.5);
            } else if (type === 'lose') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, t); 
                gain.gain.setValueAtTime(0.2, t); gain.gain.exponentialRampToValueAtTime(0.01, t+0.3);
                osc.start(t); osc.stop(t+0.3);
            }
        }

        // === UI LOGIC ===
        function selectChip(val, el) {
            if(isFlipping) return;
            currentBet = val;
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            playSound('chip');
        }

        function pickSide(side) {
            if(isFlipping) return;
            selectedSide = side;
            document.querySelectorAll('.side-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + side).classList.add('active');
            playSound('chip');
        }

        // === GAME LOGIC (RISK MANAGEMENT) ===
        function flipCoin() {
            if(isFlipping) return;
            if(!selectedSide) return alert("Select Head or Tail");
            if(myBalance < currentBet) return alert("Insufficient Balance");

            isFlipping = true;
            initAudio(); // Ensure sound works

            // 1. Deduct Balance
            const newBal = myBalance - currentBet;
            db.ref('users/' + currentUser.uid).update({ balance: newBal });

            // 2. Decide Outcome (Risk Management)
            // Rule 1: High Bet (> 500) -> 90% Loss
            // Rule 2: Streak > 3 -> Force Loss
            // Rule 3: Small Bet -> 70% Win
            
            let winChance = 0.7; 
            if(currentBet >= 500) winChance = 0.1;
            if(myStreak >= 3) winChance = 0;

            const isWin = Math.random() < winChance;
            const result = isWin ? selectedSide : (selectedSide === 'head' ? 'tail' : 'head');

            // 3. Animation
            const stage = document.getElementById('coinStage');
            const coin = document.getElementById('theCoin');
            const status = document.getElementById('statusText');
            
            status.innerText = "FLIPPING...";
            playSound('spin');
            
            stage.classList.add('toss-anim');
            coin.classList.add('spin-rapid'); // CSS spin
            
            // Set final rotation
            // 3600 (10 spins) + (0 for head, 180 for tail)
            const finalRot = 3600 + (result === 'head' ? 0 : 180);
            coin.style.transform = `rotateY(${finalRot}deg)`;

            // 4. Result
            setTimeout(() => {
                stage.classList.remove('toss-anim');
                // Reset rotation to simple 0 or 180 but keep visual
                coin.style.transition = 'none';
                coin.style.transform = result === 'head' ? 'rotateY(0deg)' : 'rotateY(180deg)';
                
                if(isWin) {
                    const profit = currentBet * 2;
                    db.ref('users/' + currentUser.uid).update({ 
                        balance: myBalance + profit, // Add profit to the ALREADY deducted balance
                        streak: myStreak + 1
                    });
                    showWin();
                } else {
                    db.ref('users/' + currentUser.uid).update({ streak: 0 });
                    playSound('lose');
                    status.innerText = "YOU LOST";
                    status.classList.add('text-red-500');
                }

                // Cleanup
                setTimeout(() => {
                    isFlipping = false;
                    coin.style.transition = 'transform 3s'; // Restore anim
                    status.classList.remove('text-red-500');
                    status.innerText = "PLAY AGAIN";
                }, 1500);

            }, 1000);
        }

        function showWin() {
            const el = document.getElementById('winScreen');
            el.classList.add('show');
            playSound('win');
            if(navigator.vibrate) navigator.vibrate(200);
            setTimeout(() => el.classList.remove('show'), 1500);
        }

    </script>
</body>
</html>
