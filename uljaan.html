<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ULTRA ADMIN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body class="bg-gray-900 text-white p-6">
    <h1 class="text-3xl font-bold mb-6 text-center text-yellow-400">ADMIN PANEL</h1>
    <div id="depositList" class="space-y-4 max-w-2xl mx-auto"></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCPLmQny1WP7yZXJuh5xjiMvU2ArfC-n54", authDomain: "ultra-earn-a636a.firebaseapp.com", projectId: "ultra-earn-a636a", storageBucket: "ultra-earn-a636a.firebasestorage.app", messagingSenderId: "185942357584", appId: "1:185942357584:web:1052b94cfecc6576944355" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        db.ref('deposits').on('value', snap => {
            const list = document.getElementById('depositList');
            list.innerHTML = "";
            snap.forEach(child => {
                const data = child.val();
                if(data.status === 'Pending') {
                    const div = document.createElement('div');
                    div.className = "bg-gray-800 p-4 rounded border border-gray-700";
                    div.innerHTML = `
                        <div class="flex justify-between font-bold mb-2">
                            <span>${data.method}</span>
                            <span class="text-green-400">Rs. ${data.amount}</span>
                        </div>
                        <p class="text-xs text-gray-400">User: ${data.uid}</p>
                        <p class="text-xs text-yellow-500 mb-4">Invited By: ${data.invitedBy}</p>
                        <div class="flex gap-2">
                            <button onclick="approve('${child.key}', '${data.uid}', ${data.amount}, '${data.invitedBy}')" class="bg-green-600 px-4 py-2 rounded text-sm font-bold flex-1">APPROVE</button>
                            <button onclick="reject('${child.key}')" class="bg-red-600 px-4 py-2 rounded text-sm font-bold flex-1">REJECT</button>
                        </div>
                    `;
                    list.appendChild(div);
                }
            });
        });

        async function approve(key, uid, amount, inviterCode) {
            if(!confirm("Approve?")) return;
            const amt = parseInt(amount);

            // 1. Give Balance to User
            const uSnap = await db.ref('users/'+uid).once('value');
            if(uSnap.exists()) {
                let bal = parseInt(uSnap.val().balance || 0);
                await db.ref('users/'+uid).update({ balance: bal + amt });
            }

            // 2. Logic for Inviter (Task Unlock)
            if(inviterCode && inviterCode !== 'Admin') {
                const iQuery = await db.ref('users').orderByChild('myCode').equalTo(inviterCode).once('value');
                iQuery.forEach(async (child) => {
                    const iData = child.val();
                    
                    // ONLY IF INVITER HAS 2000 PLAN
                    if(iData.plan === "GOLD PRO") {
                        let rewardTasks = 0;
                        if(amt >= 2000) rewardTasks = 5;
                        else if(amt >= 1500) rewardTasks = 4;
                        else if(amt >= 1000) rewardTasks = 3;
                        else if(amt >= 800) rewardTasks = 2;
                        else if(amt >= 400) rewardTasks = 1;
                        
                        if(rewardTasks > 0) {
                            let currentUnlocked = iData.unlockedTasks || 0;
                            await db.ref('users/'+child.key).update({ unlockedTasks: currentUnlocked + rewardTasks });
                            console.log("Unlocked " + rewardTasks + " tasks for inviter");
                        }
                    }
                });
            }

            await db.ref('deposits/'+key).update({ status: 'Approved' });
        }

        function reject(key) {
            if(confirm("Reject?")) db.ref('deposits/'+key).update({ status: 'Rejected' });
        }
    </script>
</body>
</html>
