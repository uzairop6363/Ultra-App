<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ULTRA ADMIN - GOD MODE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body class="bg-gray-900 text-white p-6">

    <h1 class="text-3xl font-bold text-center text-yellow-400 mb-8">ADMIN DASHBOARD</h1>

    <div class="max-w-4xl mx-auto space-y-6">
        
        <div class="bg-gray-800 p-6 rounded border border-gray-700">
            <h2 class="text-xl text-green-400 font-bold mb-4 border-b border-gray-600 pb-2">PENDING DEPOSITS</h2>
            <div id="depositList" class="space-y-3">Loading...</div>
        </div>

        <div class="bg-gray-800 p-6 rounded border border-gray-700">
            <h2 class="text-xl text-red-400 font-bold mb-4 border-b border-gray-600 pb-2">PENDING WITHDRAWALS</h2>
            <div id="withdrawList" class="space-y-3">Loading...</div>
        </div>

    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCPLmQny1WP7yZXJuh5xjiMvU2ArfC-n54",
            authDomain: "ultra-earn-a636a.firebaseapp.com",
            projectId: "ultra-earn-a636a",
            storageBucket: "ultra-earn-a636a.firebasestorage.app",
            messagingSenderId: "185942357584",
            appId: "1:185942357584:web:1052b94cfecc6576944355"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- LOAD DEPOSITS ---
        db.ref('deposits').on('value', snap => {
            const list = document.getElementById('depositList');
            list.innerHTML = "";
            let hasData = false;
            snap.forEach(child => {
                const data = child.val();
                if(data.status === 'Pending') {
                    hasData = true;
                    const div = document.createElement('div');
                    div.className = "bg-black p-4 rounded border border-gray-600 flex flex-col gap-2";
                    div.innerHTML = `
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-lg">${data.method}</span>
                            <span class="text-green-400 font-bold text-xl">Rs. ${data.amount}</span>
                        </div>
                        <div class="text-xs text-gray-400">
                            <p>Sender: ${data.senderNum}</p>
                            <p>User UID: ${data.uid}</p>
                            <p>Invited By: <span class="text-yellow-500 font-bold">${data.invitedBy || 'None'}</span></p>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <button onclick="approveDeposit('${child.key}', '${data.uid}', ${data.amount}, '${data.invitedBy}')" class="bg-green-600 flex-1 py-2 rounded font-bold hover:bg-green-500">APPROVE (Unlock Tasks Only)</button>
                            <button onclick="rejectDeposit('${child.key}')" class="bg-red-600 flex-1 py-2 rounded font-bold hover:bg-red-500">REJECT</button>
                        </div>
                    `;
                    list.prepend(div);
                }
            });
            if(!hasData) list.innerHTML = "<p class='text-gray-500 text-center'>No pending requests</p>";
        });

        // --- CORE LOGIC (NO MONEY TO INVITER) ---
        async function approveDeposit(key, uid, amount, inviterCode) {
            if(!confirm(`Approve Rs. ${amount}?\n\nNOTE: User gets Balance. Inviter gets TASKS (No Cash).`)) return;
            
            const amt = parseInt(amount);

            // 1. Credit the DEPOSITOR (User needs money to play)
            const uSnap = await db.ref('users/'+uid).once('value');
            if(uSnap.exists()) {
                const currentBal = parseInt(uSnap.val().balance || 0);
                await db.ref('users/'+uid).update({ balance: currentBal + amt });
            }

            // 2. Unlock Tasks for INVITER (IF they have 2000 Plan)
            // NO BALANCE UPDATE HERE
            if(inviterCode && inviterCode !== 'Admin') {
                const iQuery = await db.ref('users').orderByChild('myCode').equalTo(inviterCode).once('value');
                
                iQuery.forEach(async (child) => {
                    const iData = child.val();
                    
                    // Check Plan
                    if(iData.plan === "GOLD PRO") {
                        let tasksToAdd = 0;
                        
                        if(amt >= 2000) tasksToAdd = 5;
                        else if(amt >= 1500) tasksToAdd = 4;
                        else if(amt >= 1000) tasksToAdd = 3;
                        else if(amt >= 800) tasksToAdd = 2;
                        else if(amt >= 400) tasksToAdd = 1;
                        
                        if(tasksToAdd > 0) {
                            const currentUnlocked = parseInt(iData.unlockedTasks || 0);
                            await db.ref('users/'+child.key).update({
                                unlockedTasks: currentUnlocked + tasksToAdd
                            });
                            console.log(`Unlocked ${tasksToAdd} tasks for Inviter.`);
                        }
                    }
                });
            }

            // 3. Mark Done
            await db.ref('deposits/'+key).update({ status: 'Approved' });
            alert("Approved! User got Balance. Inviter got Tasks (if eligible).");
        }

        function rejectDeposit(key) {
            if(confirm("Reject this?")) db.ref('deposits/'+key).update({ status: 'Rejected' });
        }

        // --- WITHDRAWALS ---
        db.ref('withdrawals').on('value', snap => {
            const list = document.getElementById('withdrawList');
            list.innerHTML = "";
            let hasData = false;
            snap.forEach(child => {
                const data = child.val();
                if(data.status === 'Pending') {
                    hasData = true;
                    const div = document.createElement('div');
                    div.className = "bg-black p-4 rounded border border-gray-600";
                    div.innerHTML = `
                        <div class="flex justify-between font-bold mb-1">
                            <span>${data.method}</span>
                            <span class="text-red-400">Rs. ${data.amount}</span>
                        </div>
                        <p class="text-xs text-gray-400">Account: ${data.accNum}</p>
                        <p class="text-xs text-gray-400 mb-2">User UID: ${data.uid}</p>
                        <div class="flex gap-2">
                            <button onclick="approveWithdraw('${child.key}')" class="bg-green-600 flex-1 py-2 rounded font-bold">PAID</button>
                            <button onclick="rejectWithdraw('${child.key}', '${data.uid}', ${data.amount})" class="bg-red-600 flex-1 py-2 rounded font-bold">REFUND</button>
                        </div>
                    `;
                    list.appendChild(div);
                }
            });
            if(!hasData) list.innerHTML = "<p class='text-gray-500 text-center'>No pending requests</p>";
        });

        function approveWithdraw(key) {
            if(confirm("Mark as Paid?")) db.ref('withdrawals/'+key).update({ status: 'Approved' });
        }

        async function rejectWithdraw(key, uid, amount) {
            if(confirm("Reject and Refund Balance?")) {
                const uSnap = await db.ref('users/'+uid).once('value');
                if(uSnap.exists()) {
                    const currentBal = parseInt(uSnap.val().balance || 0);
                    await db.ref('users/'+uid).update({ balance: currentBal + parseInt(amount) });
                }
                db.ref('withdrawals/'+key).update({ status: 'Rejected' });
            }
        }
    </script>
</body>
</html>
