<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ULTRA ADMIN - GOD MODE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body class="bg-gray-900 text-white p-6">

    <h1 class="text-3xl font-bold text-center text-yellow-400 mb-8">ADMIN CONTROL</h1>

    <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-gray-800 p-4 rounded border border-gray-700">
            <h2 class="text-xl text-green-400 font-bold mb-4">PENDING DEPOSITS</h2>
            <div id="depositList" class="space-y-3">Loading...</div>
        </div>
        <div class="bg-gray-800 p-4 rounded border border-gray-700">
            <h2 class="text-xl text-red-400 font-bold mb-4">PENDING WITHDRAWALS</h2>
            <div id="withdrawList" class="space-y-3">Loading...</div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCPLmQny1WP7yZXJuh5xjiMvU2ArfC-n54",
            authDomain: "ultra-earn-a636a.firebaseapp.com",
            projectId: "ultra-earn-a636a",
            storageBucket: "ultra-earn-a636a.firebasestorage.app",
            messagingSenderId: "185942357584",
            appId: "1:185942357584:web:1052b94cfecc6576944355"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // LOAD DEPOSITS
        db.ref('deposits').on('value', snap => {
            const list = document.getElementById('depositList');
            list.innerHTML = "";
            snap.forEach(child => {
                const data = child.val();
                if(data.status === 'Pending') {
                    const div = document.createElement('div');
                    div.className = "bg-black p-3 rounded border border-gray-600";
                    div.innerHTML = `
                        <div class="flex justify-between font-bold"><span>${data.method}</span><span class="text-green-400">Rs. ${data.amount}</span></div>
                        <p class="text-xs text-gray-400">User: ${data.uid}</p>
                        <p class="text-xs text-yellow-500 mb-2">Invited By: ${data.invitedBy || 'None'}</p>
                        <div class="flex gap-2">
                            <button onclick="approveDeposit('${child.key}', '${data.uid}', ${data.amount}, '${data.invitedBy}')" class="bg-green-600 flex-1 py-1 rounded text-xs font-bold">APPROVE</button>
                            <button onclick="rejectDeposit('${child.key}')" class="bg-red-600 flex-1 py-1 rounded text-xs font-bold">REJECT</button>
                        </div>
                    `;
                    list.appendChild(div);
                }
            });
        });

        // LOAD WITHDRAWALS
        db.ref('withdrawals').on('value', snap => {
            const list = document.getElementById('withdrawList');
            list.innerHTML = "";
            snap.forEach(child => {
                const data = child.val();
                if(data.status === 'Pending') {
                    const div = document.createElement('div');
                    div.className = "bg-black p-3 rounded border border-gray-600";
                    div.innerHTML = `
                        <div class="flex justify-between font-bold"><span>${data.method}</span><span class="text-red-400">Rs. ${data.amount}</span></div>
                        <p class="text-xs text-gray-400">Acc: ${data.accNum} (${data.accName})</p>
                        <div class="flex gap-2 mt-2">
                            <button onclick="approveWithdraw('${child.key}')" class="bg-green-600 flex-1 py-1 rounded text-xs font-bold">PAID</button>
                            <button onclick="rejectWithdraw('${child.key}', '${data.uid}', ${data.amount})" class="bg-red-600 flex-1 py-1 rounded text-xs font-bold">REJECT</button>
                        </div>
                    `;
                    list.appendChild(div);
                }
            });
        });

        // --- CORE LOGIC: UNLOCK TASKS INSTEAD OF MONEY ---
        async function approveDeposit(key, uid, amount, inviterCode) {
            if(!confirm("Approve Rs. " + amount + "?")) return;
            const amt = parseInt(amount);

            // 1. Give Balance to DEPOSITOR (User)
            const uSnap = await db.ref('users/'+uid).once('value');
            if(uSnap.exists()) {
                const cur = parseInt(uSnap.val().balance || 0);
                await db.ref('users/'+uid).update({ balance: cur + amt });
            }

            // 2. Unlock Rewards for INVITER (No Direct Cash)
            if(inviterCode && inviterCode !== 'Admin') {
                const iQuery = await db.ref('users').orderByChild('myCode').equalTo(inviterCode).once('value');
                iQuery.forEach(async (child) => {
                    const iData = child.val();
                    
                    // CHECK: Plan must be GOLD PRO (2000)
                    if(iData.plan === "GOLD PRO") {
                        let boxesToUnlock = 0;
                        
                        // LOGIC: As per your requirement
                        if(amt >= 2000) boxesToUnlock = 5;
                        else if(amt >= 1500) boxesToUnlock = 4;
                        else if(amt >= 1000) boxesToUnlock = 3;
                        else if(amt >= 800) boxesToUnlock = 2;
                        else if(amt >= 400) boxesToUnlock = 1;
                        // < 400 = 0 boxes

                        if(boxesToUnlock > 0) {
                            const currentUnlocked = iData.unlockedTasks || 0;
                            await db.ref('users/'+child.key).update({
                                unlockedTasks: currentUnlocked + boxesToUnlock
                            });
                            console.log("Unlocked " + boxesToUnlock + " boxes for inviter.");
                        }
                    }
                });
            }

            await db.ref('deposits/'+key).update({ status: 'Approved' });
        }

        function rejectDeposit(key) {
            if(confirm("Reject?")) db.ref('deposits/'+key).update({ status: 'Rejected' });
        }

        function approveWithdraw(key) {
            if(confirm("Mark Paid?")) db.ref('withdrawals/'+key).update({ status: 'Approved' });
        }

        async function rejectWithdraw(key, uid, amount) {
            if(confirm("Reject and Refund?")) {
                const uSnap = await db.ref('users/'+uid).once('value');
                if(uSnap.exists()) {
                    const cur = parseInt(uSnap.val().balance || 0);
                    await db.ref('users/'+uid).update({ balance: cur + parseInt(amount) });
                }
                db.ref('withdrawals/'+key).update({ status: 'Rejected' });
            }
        }
    </script>
</body>
</html>
